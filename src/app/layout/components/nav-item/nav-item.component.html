<div
  class="w-full relative"
  [class.level-0]="level() === 0"
  [class.collapsed]="sidebarCollapsed()">

  @if (item().type === 'collapsable') {
    <div
      class="nav-item-collapsable flex items-center gap-3 px-4 py-3 cursor-pointer transition-all duration-200 text-sm no-underline relative"
      [class.in-active-path]="isInActivePath()"
      [class.depth-1]="getActivePathDepth() === 1"
      [class.depth-2]="getActivePathDepth() === 2"
      [style.padding-left]="sidebarCollapsed() && level() === 0 ? '12px' : getPaddingLeft()"
      (click)="toggleCollapse()"
      (mouseenter)="onMouseEnter($event)"
      (mouseleave)="onMouseLeave()"
      [matTooltip]="sidebarCollapsed() && level() === 0 ? getTooltipText() : ''"
      matTooltipPosition="right"
      [matTooltipDisabled]="!sidebarCollapsed() || level() > 0"
      matRipple>

      @if (item().icon) {
        <mat-icon class="text-[20px] w-5 h-5 flex-shrink-0 transition-colors duration-200">{{ item().icon }}</mat-icon>
      }

      @if (!sidebarCollapsed() || level() > 0) {
        <span class="flex-1 whitespace-nowrap overflow-hidden text-ellipsis">{{ item().title }}</span>

        <mat-icon class="text-[20px] w-5 h-5 flex-shrink-0 transition-transform duration-200" [class.-rotate-180]="isOpen()">
          keyboard_arrow_down
        </mat-icon>
      }
    </div>

    @if (!sidebarCollapsed() || level() > 0) {
      <div class="nav-children overflow-hidden transition-[max-height] duration-300 ease-in-out" [class.max-h-0]="!isOpen()" [class.max-h-[2000px]]="isOpen()">
        @for (child of item().children; track child.id) {
          <app-nav-item
            [item]="child"
            [level]="level() + 1"
            [sidebarCollapsed]="sidebarCollapsed()"
            [inFloatingSubmenu]="inFloatingSubmenu()">
          </app-nav-item>
        }
      </div>
    }

    @if (sidebarCollapsed() && level() === 0 && showSubmenu()) {
      <div
        class="app-theme-background floating-submenu-container fixed min-w-[240px] rounded-lg shadow-2xl ml-2 z-[1500] pointer-events-auto ring-1 ring-white/10"
        [style.top.px]="submenuPosition().top"
        [style.left.px]="submenuPosition().left"
        (mouseenter)="onSubmenuMouseEnter()"
        (mouseleave)="onSubmenuMouseLeave()">
        <div class="flex items-center gap-3 p-4 border-b border-white/10 font-semibold text-sm">
          @if (item().icon) {
            <mat-icon class="text-[20px] w-5 h-5">{{ item().icon }}</mat-icon>
          }
          <span>{{ item().title }}</span>
        </div>
        <div class="submenu-items py-2 max-h-[400px] overflow-y-auto">
          @for (child of item().children; track child.id) {
            <app-nav-item
              [item]="child"
              [level]="1"
              [sidebarCollapsed]="false"
              [inFloatingSubmenu]="true">
            </app-nav-item>
          }
        </div>
      </div>
    }
  }

  @if (item().type === 'item') {
    <a
      class="nav-item-link flex items-center gap-3 px-4 py-3 cursor-pointer transition-all duration-200 text-sm no-underline relative"
      [style.padding-left]="sidebarCollapsed() && level() === 0 ? '12px' : getPaddingLeft()"
      [routerLink]="item().url"
      routerLinkActive="active"
      #rla="routerLinkActive"
      [routerLinkActiveOptions]="{exact: false}"
      (click)="onItemClick()"
      [matTooltip]="sidebarCollapsed() && level() === 0 ? getTooltipText() : ''"
      matTooltipPosition="right"
      [matTooltipDisabled]="!sidebarCollapsed() || level() > 0"
      matRipple>

      @if (rla.isActive) {
        <div class="nav-item-indicator absolute left-0 top-0 bottom-0 w-1 rounded-r"></div>
      }

      @if (item().icon) {
        <mat-icon class="text-[20px] w-5 h-5 flex-shrink-0 transition-colors duration-200">{{ item().icon }}</mat-icon>
      }

      @if (!sidebarCollapsed() || level() > 0) {
        <span class="flex-1 whitespace-nowrap overflow-hidden text-ellipsis">{{ item().title }}</span>

        @if (item().badge) {
          <span class="inline-flex items-center justify-center text-[10px] font-semibold leading-none min-w-[18px] h-[18px] px-1.5 py-0.5 rounded-[9px] text-center flex-shrink-0 ml-auto {{ item().badge!.bg }} {{ item().badge!.fg }}">
            {{ item().badge!.title }}
          </span>
        }
      }
    </a>
  }
</div>

